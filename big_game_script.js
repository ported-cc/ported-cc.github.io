window.ccPorted=window.ccPorted||{},(()=>{let e="https://us-west-2lg1qptg2n.auth.us-west-2.amazoncognito.com",t="4d6esoka62s46lo4d398o3sqpi",r=`${window.location.origin}`;l(window.gameID||window.ccPorted.gameID);let o=u(),n=/\/(game_\w+)\//,a=n.exec(window.location.pathname),s=o&&document.location.ancestorOrigins.length>0?new URL(document.location.ancestorOrigins[0]).origin:null,c=void 0!==window.ccPorted.gameID&&"undefined"!=window.ccPorted.gameID?window.ccPorted.gameID:window.gameID||(a?a[1]:"Unknown Game");function i(){window.addEventListener("message",e=>{if(e.origin===s&&e.data&&e.data.action&&"CACHE_CONTROL"===e.data.type)switch(e.data.action){case"CLEAR_CACHE":if(navigator.serviceWorker.controller){let t=new MessageChannel;t.port1.onmessage=e=>{console.log("Cache cleared:",e.data)},navigator.serviceWorker.controller.postMessage({action:"CLEAR_CACHE"},[t.port2])}break;case"CACHE_STATUS":navigator.serviceWorker.getRegistration().then(t=>{e.source.postMessage({action:"CACHE_STATUS_RESPONSE",active:!!t?.active,size:null},e.origin)})}})}"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("/game_worker.js",{scope:"/"}).then(e=>{console.log("Game service worker registered:",e);let t=window!==window.top;t&&(window.parent.postMessage({action:"CACHE_ENABLED",gameId:c},"*"),i())}).catch(e=>{console.error("Service worker registration failed:",e)})}):console.warn("Service workers are not supported in this browser.");class ${constructor(e){if(!e)throw Error("Game ID is required");this.gameID=e,this.cached=[],this.loading=!1,this.needsRefresh=!1,this.score=0}async loadScores(){if(this.loading&&this.cached.length>0||this.cached.length>0&&!this.needsRefresh)return this.cached;await window.ccPorted.awsPromise,this.loading=!0;try{let e=await window.ccPorted.query({TableName:"leaderboard",IndexName:"gameID-score-index",Limit:10,ScanIndexForward:!1,KeyConditionExpression:"gameID = :gameID AND score > :score",ExpressionAttributeValues:{":gameID":this.gameID,":score":0}});this.loading=!1;var t=!1,r=e.Items.map((e,r)=>(("guest"==e.userID||e.userID==window.ccPorted?.user?.sub)&&(t=!0),{score:e.score,id:e.userID,display_name:e.displayName,rank:r+1}));return void 0!=this.guestScore&&(r.push({score:this.guestScore,display_name:"Guest",userID:"guest"}),r.sort((e,t)=>t.score-e.score)),this.cached=r,this.needsRefresh=!1,r}catch(o){console.log("[LEADERBOARD] Error getting scores",o)}}addGuestScore(e){this.guestScore=e,this.cached.length>0&&(this.cached.push({score:e,display_name:"Guest",userID:"guest"}),this.cached.sort((e,t)=>t.score-e.score))}formatScore(e){if(e<1e3)return e;if(e<1e6)return(e/1e3).toFixed(2)+"K";if(e<1e9)return(e/1e6).toFixed(2)+"M";if(e<1e12)return(e/1e9).toFixed(2)+"B";if(e<1e15)return(e/1e12).toFixed(2)+"T";else if(e<1e18)return(e/1e15).toFixed(2)+"Q";else if(e<1e21)return(e/1e18).toFixed(2)+"QQ";else if(e<1e24)return(e/1e21).toFixed(2)+"S";else if(e<1e27)return(e/1e24).toFixed(2)+"SS";else if(e<1e30)return(e/1e27).toFixed(2)+"O";else if(e<1e33)return(e/1e30).toFixed(2)+"N";else if(e/1e33)return(e/1e33).toFixed(2)+"D";else return e.toExponential(2)}async addScore(e){if(d("adding score"),!window.ccPorted.user)return this.addGuestScore(e);try{let t=await window.ccPorted.query({TableName:"leaderboard",KeyConditionExpression:"gameID = :gameID AND userID = :userID",ExpressionAttributeValues:{":gameID":this.gameID,":userID":window.ccPorted.user.sub},Limit:1}),r=t.Items;if(r&&r.length>0&&r[0].score>=e){d("Old score is higher"),this.score={score:e,userID:window.ccPorted.user.sub,displayName:window.ccPorted.user.attributes.preferred_username||window.ccPorted.user["cognito:username"]||"Anonymous"};return}let o={gameID:this.gameID,userID:window.ccPorted.user.sub,score:e,displayName:window.ccPorted.user.attributes.preferred_username||window.ccPorted.user["cognito:username"]||"Anonymous"},n={TableName:"leaderboard",Key:{gameID:this.gameID,userID:window.ccPorted.user.sub},UpdateExpression:"set score = :s, displayName = :d",ExpressionAttributeValues:{":s":e,":d":o.displayName}};await window.ccPorted.documentClient.update(n).promise(),d("Score updated"),this.needsRefresh=!0}catch(a){console.error(a),d(a)}}clearCache(){this.cached=[]}}function d(...e){console.log(`[${c}]: `,...e)}function l(e){return e?e.split(".").join("-"):null}function u(){try{return window.self!==window.top}catch(e){return!0}}function g(e,t){d(`Creating shortcut for keys ${e}, calling ${t.name}`);var r={};for(let o of e)r[o]=!1;document.addEventListener("keydown",o=>{void 0!==r[o.which]&&(r[o.which]=!0),function t(){var o=!0;for(let n of e)r[n]||(o=!1);return o}()&&t()}),document.addEventListener("keyup",e=>{void 0!==r[e.which]&&(r[e.which]=!1)})}function f(){return new Promise((e,t)=>{AWS.config.credentials.expired=!0,AWS.config.credentials.refresh(r=>{r?(t(r),d("Failed to refresh credentials:",r)):(d("Credentials refreshed successfully"),e())})})}function m(e){try{let t=e.split(".")[1],r=t.replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(atob(r))}catch(o){return console.error("Invalid JWT token:",o),null}}function h(e){if(!e||!e.exp)return!0;let t=1e3*e.exp;return Date.now()>=t}function p(e="ccported"){let t=`[ns_${e}]`,r=window.localStorage,o=window.indexedDB,n=RegExp("^\\[ns_[a-zA-Z0-9_-]+\\]_"),a=new Proxy(localStorage,{get:function(e,o){switch(o){case"setItem":return function(e,o,a=!1){return a?r.setItem("[ns_ccported]_"+e,o):r.getItem(`[ns_ccported]_${e}`)?r.setItem(`[ns_ccported]_${e}`,o):r.getItem(`${t}_${e}`)?r.setItem(`${t}_${e}`,o):n.test(e)?r.setItem(e,o):r.setItem(`${t}_${e}`,o)};case"getItem":return function(e){return r.getItem(`[ns_ccported]_${e}`)?r.getItem(`[ns_ccported]_${e}`):r.getItem(`${t}_${e}`)?r.getItem(`${t}_${e}`):n.test(e)?r.getItem(e):r.getItem(`${t}_${e}`)};case"removeItem":return function(e){return r.getItem(`[ns_ccported]_${e}`)?r.removeItem(`[ns_ccported]_${e}`):r.getItem(`${t}_${e}`)?r.removeItem(`${t}_${e}`):n.test(e)?r.removeItem(e):void 0};case"clear":return function(e=!1){if(e)return r.clear();for(let o=r.length-1;o>=0;o--){let n=r.key(o);n.startsWith(`${t}_`)&&r.removeItem(n)}};case"key":return function(e,o=!1){if(o)return r.key(e);let n=[];for(let a=0;a<r.length;a++){let s=r.key(a);s.startsWith(`${t}_`)&&n.push(s.slice(t.length+1))}return n[e]};case"length":let a=0;for(let s=0;s<r.length;s++)r.key(s).startsWith(`${t}_`)&&a++;return a;case"globalLength":return r.length;default:if(r.getItem(`[ns_ccported]_${o}`))return r.getItem(`[ns_ccported]_${o}`);if(r.getItem(`${t}_${o}`))return r.getItem(`${t}_${o}`);if(n.test(o))return r.getItem(o)}},set:function(e,o,a){return(["getItem","setItem","removeItem","clear","key","length","globalLength"].forEach(e=>{if(o===e)throw Error(`Cannot overwrite localStorage method ${e}`)}),r.getItem(`[ns_ccported]_${o}`))?r.setItem(`[ns_ccported]_${o}`,a):r.getItem(`${t}_${o}`)?r.setItem(`${t}_${o}`,a):n.test(o)?r.setItem(o,a):r.setItem(`${t}_${o}`,a)}}),s=new Proxy(window.indexedDB,{get:function(e,r){if("open"===r)return function(e,r){let a=n.test(e);if(a||e.startsWith("[ns_ccported]_"))return o.open(e,r);let s=`${t}_${e}`,c=async()=>{try{let t=await o.databases(),r=t.some(t=>t.name===e);return console.log(`Checking for database '${e}': ${r}`),r}catch(n){return console.error("Error checking databases:",n),!1}},i=o.open(s,r);return i.onerror=function(e){console.error(`Error opening database ${s}:`,e.target.error)},i.onupgradeneeded=function(t){console.log(`Upgrade needed for ${s}`);let r=t.target.result;c().then(t=>{if(t){console.log(`Found old database '${e}', initiating transfer`);let n=o.open(e);n.onerror=function(t){console.error(`Error opening old database ${e}:`,t.target.error)},n.onsuccess=function(t){let n=t.target.result;console.log(`Successfully opened old database '${e}'`),console.log("Object stores found:",Array.from(n.objectStoreNames));let a=Array.from(n.objectStoreNames);if(0===a.length){console.log(`No object stores found in old database '${e}'`),n.close();return}a.forEach(t=>{console.log(`Transferring object store: ${t}`);try{let s=n.transaction(t,"readonly"),c=s.objectStore(t),i=c.getAll();i.onsuccess=function(){try{if(!r.objectStoreNames.contains(t)){console.log(`Creating new object store: ${t}`);let e=r.createObjectStore(t,c.keyPath?{keyPath:c.keyPath}:{autoIncrement:c.autoIncrement});Array.from(c.indexNames).forEach(t=>{let r=c.index(t);e.createIndex(t,r.keyPath,{unique:r.unique,multiEntry:r.multiEntry})})}let o=r.transaction(t,"readwrite"),n=o.objectStore(t),a=i.result;console.log(`Transferring ${a.length} items for store ${t}`),a.forEach(e=>{try{n.add(e)}catch(r){console.error(`Error adding item to ${t}:`,r)}}),o.oncomplete=function(){console.log(`Completed transfer for store: ${t}`)},o.onerror=function(e){console.error(`Error in transfer transaction for ${t}:`,e.target.error)}}catch(s){console.error(`Error processing store ${t}:`,s)}},i.onerror=function(e){console.error(`Error getting data from ${t}:`,e.target.error)},s.oncomplete=function(){if(console.log(`Old database transaction complete for: ${t}`),t===a[a.length-1]){n.close();let r=o.deleteDatabase(e);r.onsuccess=function(){console.log(`Successfully deleted old database: ${e}`)},r.onerror=function(t){console.error(`Error deleting old database ${e}:`,t.target.error)}}}}catch($){console.error(`Error in store transfer process for ${t}:`,$)}})}}else console.log(`No old database found for '${e}'`)})},i};if("deleteDatabase"===r)return function(e){if(n.test(e))return o.deleteDatabase(e);let r=`${t}_${e}`;return o.deleteDatabase(r)};if("databases"===r)return async function(){let e=await o.databases();return e.map(e=>(e.name=e.name.replace(t+"_",""),e))};{let a=o[r];return"function"==typeof a?a.bind(o):a}}});async function c(e,r){let n=`${t}_${e}`,a=await o.databases(),s=a.some(t=>t.name===e);return s?(console.log(`Manually migrating database: ${e}`),new Promise((t,a)=>{let s=o.open(n,r||1);s.onerror=function(e){console.error(`Error opening namespaced database ${n}:`,e.target.error),a(e.target.error)},s.onsuccess=function(s){s.target.result,console.log(`Successfully opened namespaced database '${n}'`);let c=o.open(e);c.onerror=function(t){console.error(`Error opening old database ${e}:`,t.target.error),a(t.target.error)},c.onsuccess=function(s){let c=s.target.result;console.log(`Successfully opened old database '${e}'`);let i=Array.from(c.objectStoreNames);if(console.log("Object stores found:",i),0===i.length){console.log(`No object stores found in old database '${e}'`),c.close(),t();return}let $=0,d=o.open(n,(r||1)+1);d.onupgradeneeded=function(e){let t=e.target.result;i.forEach(e=>{if(!t.objectStoreNames.contains(e)){let r=c.transaction(e).objectStore(e),o=t.createObjectStore(e,r.keyPath?{keyPath:r.keyPath}:{autoIncrement:r.autoIncrement});Array.from(r.indexNames).forEach(e=>{let t=r.index(e);o.createIndex(e,t.keyPath,{unique:t.unique,multiEntry:t.multiEntry})})}})},d.onsuccess=function(r){let n=r.target.result;i.forEach(r=>{console.log(`Transferring object store: ${r}`);try{let s=c.transaction(r,"readonly"),d=s.objectStore(r),l=d.getAll();l.onsuccess=function(){try{let s=l.result;console.log(`Transferring ${s.length} items for store ${r}`);let d=n.transaction(r,"readwrite"),u=d.objectStore(r);s.forEach(e=>{try{u.add(e)}catch(t){console.error(`Error adding item to ${r}:`,t)}}),d.oncomplete=function(){if(console.log(`Completed transfer for store: ${r}`),++$===i.length){console.log("All stores transferred successfully"),c.close(),n.close();let s=o.deleteDatabase(e);s.onsuccess=function(){console.log(`Successfully deleted old database: ${e}`),t()},s.onerror=function(t){console.error(`Error deleting old database ${e}:`,t.target.error),a(t.target.error)}}},d.onerror=function(e){console.error(`Error in transfer transaction for ${r}:`,e.target.error),a(e.target.error)}}catch(g){console.error(`Error processing store ${r}:`,g),a(g)}},l.onerror=function(e){console.error(`Error getting data from ${r}:`,e.target.error),a(e.target.error)}}catch(u){console.error(`Error in store transfer process for ${r}:`,u),a(u)}})},d.onerror=function(e){console.error(`Error upgrading database ${n}:`,e.target.error),a(e.target.error)}}}})):(console.log(`No old database found for '${e}'`),Promise.resolve())}return function e(){Object.defineProperty(window,"localStorage",{value:a,writable:!1,configurable:!0}),Object.defineProperty(window,"indexedDB",{value:s,writable:!1,configurable:!0}),window.ccPorted.migrateDatabase=c}}async function w(e=5e3){return new Promise((t,r)=>{let o=Date.now().toString(36)+Math.random().toString(36).substring(2),n=e=>{if(e.origin!==s)return;let r=e.data;if(r.requestId===o){if(window.removeEventListener("message",n),"SET_TOKENS"===r.action){let a=r.content;localStorage.setItem("[ns_ccported]_accessToken",a.accessToken),localStorage.setItem("[ns_ccported]_idToken",a.idToken),localStorage.setItem("[ns_ccported]_refreshToken",a.refreshToken),t(a)}else"NO_USER"===r.action?(console.log("No user found in parent, initializing unauthenticated."),t(null)):"UNKNOWN_ACTION"===r.action&&(console.log("Unknown action received from parent:",r.action),t())}};window.addEventListener("message",n),window.parent.postMessage({action:"GET_TOKENS",requestId:o,fromInternal:!0},s),setTimeout(()=>{window.removeEventListener("message",n),r(Error("Timeout getting tokens from parent"))},e)})}async function y(){return AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:"us-west-2:8ffe94a1-9042-4509-8e65-4efe16e61e3e"}),await f(),d("Configured AWS SDK with unauthenticated credentials"),null}async function I(e,t,r){let o=m(e);if(h(o)){d("ID token expired, attempting refresh...");let n=await P(r);if(!n)return console.error("Failed to refresh token. User must log in again."),y();o=m(n.id_token)}AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:"us-west-2:8ffe94a1-9042-4509-8e65-4efe16e61e3e",RoleSessionName:o.sub}),AWS.config.credentials.params.Logins=AWS.config.credentials.params.Logins||{},AWS.config.credentials.params.Logins["cognito-idp.us-west-2.amazonaws.com/us-west-2_lg1qptg2n"]=e,await f();let a=await window.ccPorted.identityProvider.getUser({AccessToken:t}).promise();d("User attributes recieved");let s=a.UserAttributes.reduce((e,{Name:t,Value:r})=>(e[t]=r,e),{}),c={...o,attributes:s};return c}async function b(){var e=null;if(window.ccPorted.awsReady=!1,"undefined"==typeof AWS){d("AWS SDK not loaded, loading...");let t=document.createElement("script");t.src="https://sdk.amazonaws.com/js/aws-sdk-2.1030.0.min.js",document.head.appendChild(t),await new Promise((e,r)=>{d("Waiting for AWS SDK to load..."),t.onload=e}),d("AWS SDK loaded")}if(window.ccPorted.AWS=AWS,AWS.config.update({region:"us-west-2"}),window.ccPorted.identityProvider=new AWS.CognitoIdentityServiceProvider({region:"us-west-2"}),o)try{let r=await w();if(r&&null!=r){let{idToken:n,accessToken:a,refreshToken:s}=r;n&&a?e=await I(n,a,s):(console.log("Invalid tokens received, initializing unauthenticated."),e=await y())}else console.warn("No tokens received from parent. Initializing unauthenticated."),e=await y()}catch(c){console.error("Authentication error:",c.message),e=await y()}else{let i=localStorage.getItem("[ns_ccported]_idToken"),$=localStorage.getItem("[ns_ccported]_accessToken"),l=localStorage.getItem("[ns_ccported]_refreshToken");if(i&&$)d("Tokens found. Initializing user..."),e=await I(i,$,l);else{console.warn("No valid tokens found. Checking for auth code...");let u=new URLSearchParams(window.location.search).get("code");if(u){console.log("Auth code found. Exchanging for tokens...");let g=await k(u);g?(i=g.id_token,e=await I(i,$=g.access_token,l=g.refresh_token)):(console.error("Failed to exchange auth code for tokens."),e=await y())}else console.warn("No auth code found in URL. User may need to log in."),e=await y()}}window.ccPorted.s3Client=new AWS.S3({region:"us-west-2"}),window.ccPorted.documentClient=new AWS.DynamoDB.DocumentClient({region:"us-west-2"}),window.ccPorted.awsReady=!0,window.ccPorted.user=e,window.ccPorted.getUser=()=>e}async function k(o){try{let n=await fetch(`${e}/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:t,redirect_uri:r,code:o})}),a=await n.json();if(a.error)throw Error(a.error_description||"Failed to exchange auth code");return localStorage.setItem("[ns_ccported]_accessToken",a.access_token),localStorage.setItem("[ns_ccported]_idToken",a.id_token),localStorage.setItem("[ns_ccported]_refreshToken",a.refresh_token),window.history.replaceState({},document.title,r),a}catch(s){return console.error("Error exchanging auth code:",s),null}}async function P(r){if(!r)return console.warn("No refresh token available."),null;try{let o=await fetch(`${e}/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:t,refresh_token:r})}),n=await o.json();if(n.error)throw Error(n.error||"Token refresh failed");return localStorage.setItem("[ns_ccported]_accessToken",n.access_token),localStorage.setItem("[ns_ccported]_idToken",n.id_token),console.log("Tokens refreshed successfully"),n}catch(a){return console.error("Error refreshing token:",a),null}}window.ccPorted.Leaderboard=$,window.ccPorted.getUserTokens=()=>({accessToken:localStorage.getItem("[ns_ccported]_accessToken"),idToken:localStorage.getItem("[ns_ccported]_idToken"),refreshToken:localStorage.getItem("[ns_ccported]_refreshToken")}),window.ccPorted.downloadFile=async e=>(await window.ccPorted.awsPromise,new Promise((t,r)=>{window.ccPorted.s3Client.getObject({Bucket:"ccporteduserobjects",Key:`${window.ccPorted.user.sub}/${e}`},(e,o)=>{e?r(e):t(o)})})),window.ccPorted.uploadFile=async(e,t,r={})=>(await window.ccPorted.awsPromise,new Promise((o,n)=>{let a={Bucket:"ccporteduserobjects",Key:`${window.ccPorted.user.sub}/${t}`,Body:e,ContentType:e.type,PartSize:5242880,QueueSize:10,...r};window.ccPorted.s3Client.upload(a,(e,t)=>{e?n(e):o(t)})})),window.ccPorted.updateUser=async e=>(await window.ccPorted.awsPromise,new Promise((t,r)=>{window.ccPorted.identityProvider.updateUserAttributes({AccessToken:window.ccPorted.getUserTokens().accessToken,UserAttributes:Object.entries(e).map(([e,t])=>({Name:e,Value:t}))},(e,o)=>{e?r(e):t(o)})})),window.ccPorted.query=async(...e)=>{await window.ccPorted.awsPromise;let[t,r,o,n]=e;return new Promise("object"==typeof t?(e,r)=>{window.ccPorted.documentClient.query(t,(t,o)=>{t?r(t):e(o)})}:(e,a)=>{let s={TableName:o,KeyConditionExpression:`${t} = :partitionKey`,ExpressionAttributeValues:{":partitionKey":r},...n};window.ccPorted.documentClient.query(s,(t,r)=>{t?a(t):e(r)})})},window.ccPorted.getUser=()=>window.ccPorted.user?user:window.ccPorted.userPromise,window.ccPorted.awsPromise=new Promise(async(e,t)=>{try{await b(),e(window.ccPorted)}catch(r){t(r)}}),window.ccPorted.userPromise=new Promise(async(e,t)=>{await window.ccPorted.awsPromise;let r=window.ccPorted.user;if(r){let o=document.querySelector(".loggedInReplacable");o&&(o.textContent=r["cognito:username"],o.href="/profile/"),e(r)}else console.log("No user data found, returning null"),e(null)}),(!window.ccPorted.config||void 0===window.ccPorted.config?.sandboxStorage||window.ccPorted.config.sandboxStorage)&&p(window.gameID||"ccported")()})();